---
title: "Assignment 2"
author: Group 20, Aliya Mosha (s2206786), Saioa Galvin (s2516907), Hugh Graham (s2318382),
  (... words)
date: "2025-10-29"
output:
  html_document: default
  pdf_document: default
---

```{r load_packages, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(afex))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(cv))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(fitdistrplus))
suppressPackageStartupMessages(library(readxl))

theme_set(theme_bw())
```

```{r reading_code, code=readLines("code.R"), eval=FALSE, echo=FALSE, message=FALSE}
source("code.R")
```

```{r data_wrangling, echo = FALSE, message = FALSE, fig.width=20, fig.height=40, fig.align='center'}
# --- data wrangling ---
data <- read_excel("SCS_BAC_and_BrAC_split_TOP.xlsx")
data$sex <- as.factor(data$Sex)
data$beta60 <- data$`Beta60 (g/kg/h)`
data$weight <- data$`Weight (kg)`
data$height <- data$`Height (cm)`
data$age <- data$`Age (years)`
data$beta <- -data$beta60
```

# Executive Summary

# Task 1

## Exploratory Data Analysis

```{r eda, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
# --- beta60 EDA ---

# beta60 vs weight
weight_plot <- ggplot(data, aes(x=weight, y=beta60, colour = sex)) +
  geom_point() +
  geom_smooth(method="lm", color="navy") +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  labs(title="Figure 1: Beta60 vs Weight", x="Weight (kg)", y="Beta60 (g/kg/h)")

# beta60 vs height
height_plot <- ggplot(data, aes(x=height, y=beta60, colour = sex)) +
  geom_point() +
  geom_smooth(method="lm", color="navy") +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  labs(title="Figure 2: Beta60 vs Height", x="Weight (cm)", y="Beta60 (g/kg/h)")

# beta60 vs age
age_plot <- ggplot(data, aes(x=age, y=beta60, colour = sex)) +
  geom_point() +
  geom_smooth(method="lm", color="navy") +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  labs(title="Figure 3: Beta60 vs Age", x="Age (years)", y="Beta60 (g/kg/h)")

# beta60 vs gender
sex_plot <- ggplot(data, aes(x = sex, y = beta60,
                             fill = sex)) +
  geom_violin(alpha = 0.8) +
  geom_boxplot(width = 0.2, color = "navy", alpha = 0.7) +
  scale_fill_manual(values = c("lightblue", "steelblue")) +
  labs(
    title = "Figure 4: Beta60 vs Gender",
    x = "Gender",
    y = "Beta60 (g/kg/h)"
  ) +
  guides(fill = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

(weight_plot + height_plot) /
  (age_plot + sex_plot) /
  plot_layout(ncol = 1) +
  plot_annotation(
    title = "Beta60 vs Characteristics Plots",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )
```

```{r correlations, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
library(dplyr)

# pairwise correlations between characteristics and beta60
corr <- data %>%
  dplyr::select(beta60, weight, age, height) %>%
  cor(use = "pairwise.complete.obs") %>%
  round(3)

print(corr)

# quantiles of beta60
quantiles <- quantile(data$beta60, probs = c(0.025, 0.5, 0.975))
print(quantiles)
```

## Modelling Beta

### Finding Distribution Method

An issue with creating a distribution from the Beta_60 values given, is that we only have 100 data points. Therefore the distribution is very dependent on not many datapoints. We propose instead investigating if beta_60 follows a standard distribution. First, we will look at the spread of beta_60 values given in the following histogram.

```{r density_plot, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}

density_plot <- ggplot(data, aes(x = beta60)) +
  geom_histogram(aes(y = after_stat(density)),
                 binwidth = 0.005,
                 fill = "navy",
                 alpha = 0.55) +
  geom_density(color = "navy", 
               size = 1) +
  geom_vline(aes(xintercept=mean(beta60)),
             linetype = "dashed",
             color = "navy",
             size = 1) +
  geom_vline(aes(xintercept=quantile(beta60, 0.025)),
             linetype = "dotted",
             color = "navy",
             size = 1) +
  geom_vline(aes(xintercept=quantile(beta60, 0.975)),
             linetype = "dotted",
             color = "navy",
             size = 1) +
  labs(x = "beta_60", y = "Density", title = "Distribution of Beta60 (g/kg/h)")

density_plot
```

We have seen from exploratory data analysis that the rate at which alcohol density in the blood decreases is dependent on a range of variables given in the data. As Sex is the only discrete variable, we can split the data in two to see how beta is distributed for males and females in the dataset given.

```{r sex_density_plot, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
# compute group statistics
stats <- data %>%
  group_by(Sex) %>%
  summarize(
    mean = mean(beta60),
    q025 = quantile(beta60, 0.025),
    q975 = quantile(beta60, 0.975)
  )

# plot
sex_density_plot <- ggplot(data, aes(x = beta60, color = Sex, fill = Sex)) +
  geom_histogram(aes(y = after_stat(density)),
                 binwidth = 0.005, alpha = 0.4, position = "identity") +
  geom_density(size = 1, alpha= 0) +
  geom_vline(data = stats, aes(xintercept = mean, color = Sex),
             linetype = "dashed", size = 1) +
  geom_vline(data = stats, aes(xintercept = q025, color = Sex),
             linetype = "dotted", size = 1) +
  geom_vline(data = stats, aes(xintercept = q975, color = Sex),
             linetype = "dotted", size = 1) +
  scale_color_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  scale_fill_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  theme_minimal() +
  labs(x = "beta_60", y = "Density", title = "Distribution of Beta60 (g/kg/h) by Sex")

sex_density_plot
```

This visualisation can point us towards a few different distributions. We can start with normal.

```{r normal, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
normal_fit <- fitdist(-data$beta60, distr = "norm", method = "mle")
par(mar=c(1, 1, 1, 1))
plot(normal_fit)
```

While this follows the general trend, the data violates the normality assumptions. Therefore we considered the beta distribution.

```{r beta, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
beta_fit <- fitdist(-data$beta60, distr = "beta", method = "mle")
par(mar=c(1, 1, 1, 1))
plot(beta_fit)
```

This is an improved fit compared to the normal distribution, as the empirical and theoretical densities are more aligned, and ... A similar distribution is the gamma distribution.

```{r gamma, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
gamma_fit <- fitdist(-data$beta60, distr = "gamma", method = "mle")
par(mar=c(1, 1, 1, 1))
plot(gamma_fit)

gamma_shape <- gamma_fit$estimate[[1]]
gamma_rate <- gamma_fit$estimate[[2]]
q025 <- -qgamma(0.975, gamma_shape, gamma_rate)
```

The 2.5% quantile in this distribution of Beta_60 is -0.2529983. 

Considering that Sex is a factor variable, we can find the distributions of beta_60 dependent on whether the suspect is male of female.

```{r gamma_sex, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
m_data <- data %>% filter(Sex == "male")
m_gamma_fit <- fitdist(-m_data$beta60, distr = "gamma", method = "mle")
m_gamma_shape <- m_gamma_fit$estimate[[1]]
m_gamma_rate <- m_gamma_fit$estimate[[2]]
m_q025 <- -qgamma(0.975, m_gamma_shape, m_gamma_rate)

f_data <- data %>% filter(Sex == "female")
f_gamma_fit <- fitdist(-f_data$beta60, distr = "gamma", method = "mle")
f_gamma_shape <- f_gamma_fit$estimate[[1]]
f_gamma_rate <- f_gamma_fit$estimate[[2]]
f_q025 <- -qgamma(0.975, f_gamma_shape, f_gamma_rate)

plot(m_gamma_fit)
plot(f_gamma_fit)

m_q025
f_q025
```

### Linear Model Method
```{r modelling_beta, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}
# --- linear modelling beta 60 attempt ---

# model incorporating all characteristics
model <- lm(beta60 ~ weight + age + height + sex, data = data)
summary(model)

# Residual plots
par(mfrow = c(2,2))
plot(model)
```

```{r lm, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}

# Try modelling square root of beta (residual plots indicate a slight quadratic mean-variance relationship)

sqrt_model <- lm(sqrt((-1)*beta60) ~ weight + age + height + sex, data = data)
summary(sqrt_model)

# Residual plots
par(mfrow = c(2,2))
plot(sqrt_model)
```


## Task 2

```{r task_2, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}

# setup from question
test_person <- data.frame(weight = 70, height = 160, age = 70, sex = "female")
Ct <- 0.15
t  <- 2

# empirical quantiles for Beta60 (population approach)
beta_pop <- quantile(data$beta60, probs = c(0.025, 0.5, 0.975))
beta_pop

# C0 values using population quantiles
C0_pop <- Ct + beta_pop * t
C0_pop_abs <- Ct + abs(beta_pop) * t   # absolute values since beta60 is negative

# gamma fitted whole population distribution
gamma_quantiles <- -qgamma(c(0.975, 0.5, 0.025), gamma_shape, gamma_rate)
C0_gamma <- Ct + q025 * t
C0_gamma_abs <- Ct + abs(q025) * t

# predicted Beta60 using regression model
pred_vals <- predict(model, newdata = test_person, interval = "prediction", level = 0.95)
pred_vals

# C0 values using model prediction
beta_pred <- as.numeric(pred_vals)
names(beta_pred) <- c("Fitted", "Lower (PI 2.5%)", "Upper (PI 97.5%)")

C0_model <- Ct + beta_pred * t
C0_model_abs <- Ct + abs(beta_pred) * t

# combine results into one comparison table 
results_table <- tibble(
  Approach = c("Population (empirical quantiles)", "Model-based (predicted)", "Gamma Fitted"),
  Lower_2.5 = c(C0_pop_abs[1], C0_model_abs[2], C0_gamma_abs[1]),  # note ordering: lwr=2nd col in pred
  Central   = c(C0_pop_abs[2], C0_model_abs[1], C0_gamma_abs[2]),
  Upper_97.5 = c(C0_pop_abs[3], C0_model_abs[3], C0_gamma_abs[3])
)

kable(results_table, digits = 3,
      col.names = c("Approach", "Lower (2.5%)", "Central", "Upper (97.5%)"),
      caption = "Comparison of estimated C₀ values for the population, model-based and gamma-fitting approaches")
```

## Task 3

If it is too late for a blood or breath test to predict accurate results for $C_0$, but there is eyewitness evidence measuring the quantity of alcohol consumed, the Widmark's equation can help to calculate the blood alcohol concentration $t$ hours after drinking ($C_t$). Widmark's equation can be written as

$$
C_t = \frac{A}{\text{Weight} \times V_d} - \beta t,
$$

where $A$ is the observed does of alcohol consumed, $\text{Weight}$ is the weight of the individual, and $V_d$ is a parameter known as the volume of distribution. Rearranging this equation we find

$$
C_0 = C_t +\beta_t = \frac{A}{\text{Weight} \times V_d},
$$

which in turn implies

$$
V_d = \frac{A}{\text{Weight} \times C_0}.
$$

Hence, given we are provided the data for $A$, $\text{Weight}$, and $C_0$, we can calculate $V_d$ using the above equation.

If it is too late for a blood or breath test to predict accurate results for $C_0$, but there is eyewitness evidence measuring the quantity of alcohol consumed, the Widmark's equation can help to calculate the blood alcohol concentration $t$ hours after drinking ($C_t$). Widmark's equation can be written as

$$
C_t = \frac{A}{\text{Weight} \times V_d} - \beta t,
$$

where $A$ is the observed does of alcohol consumed, $\text{Weight}$ is the weight of the individual, and $V_d$ is a parameter known as the volume of distribution. Rearranging this equation we find

$$
C_0 = C_t +\beta_t = \frac{A}{\text{Weight} \times V_d},
$$

which in turn implies

$$
V_d = \frac{A}{\text{Weight} \times C_0}.
$$

Hence, given we are provided the data for $A$, $\text{Weight}$, and $C_0$, we can calculate $V_d$ using the above equation.

```{r task_3, echo = FALSE, message = FALSE, warning=FALSE, fig.width=20, fig.height=10, fig.align='center'}

# define A, Co, Vd
data$A <- data$`Amount of Alcohol Consumed (g)`
data$Co <- data$`Co (g/Kg)`
data$Vd <- data$A/(data$Co *data$weight)

# view summary and quantiles of Vd
summary(data$Vd)
quantile(data$Vd, probs = c(0.025, 0.5, 0.975))

# histogram of Vd
ggplot(data, aes(x = Vd)) +
  geom_histogram(bins = 20, colour = "navy", fill = "steelblue") +
  labs(title = "Distribution of Volume of Distribution (Vd)",
       x = "Vd (L/kg)", y = "Count")

# Vd vs weight
weight_plot2 <- ggplot(data, aes(x = weight, y = Vd, colour = sex)) +
  geom_point() +
  geom_smooth(method = "lm", colour = "navy") +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  labs(title = "Figure 5: Vd vs Weight", x = "Weight (kg)", y = "Vd (L/kg)")

# Vd vs height
height_plot2 <- ggplot(data, aes(x = height, y = Vd, colour = sex)) +
  geom_point() +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  geom_smooth(method = "lm", colour = "navy") +
  labs(title = "Figure 6: Vd vs Height", x = "Height (cm)", y = "Vd (L/kg)")

# Vd vs age
age_plot2 <- ggplot(data, aes(x = age, y = Vd, colour = sex)) +
  geom_point() +
  scale_colour_manual(values = c("male" = "steelblue", "female" = "lightblue")) +
  geom_smooth(method = "lm", colour = "navy") +
  labs(title = "Figure 7: Vd vs Age", x = "Age (years)", y = "Vd (L/kg)")

# Vd vs gender
sex_plot2 <- ggplot(data, aes(x = sex, y = Vd,
                             fill = sex)) +
  geom_violin(alpha = 0.8) +
  geom_boxplot(width = 0.2, color = "navy", alpha = 0.7) +
  scale_fill_manual(values = c("lightblue", "steelblue")) +
  labs(
    title = "Figure 8: Vd vs Gender",
    x = "Gender",
    y = "Vd (L/kg)"
  ) +
  guides(fill = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

(weight_plot2 + height_plot2) /
  (age_plot2 + sex_plot2) /
  plot_layout(ncol = 1) +
  plot_annotation(
    title = "Vd Characteristics Plots",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )

```


```{r}

# Test correlation to investigate independent assumption
cor.test(data$beta, data$Vd, use = "complete.obs")


# View quantiles of each coefficient for comparison
beta_range <- quantile(data$beta60, probs = c(0.025, 0.975))
Vd_range   <- quantile(data$Vd, probs = c(0.025, 0.975))


# Scatter plot between beta and V_d
ggplot(data, aes(x = beta, y = Vd)) +
  geom_point(aes(color = sex), alpha = 0.6) +
  geom_smooth(method = "lm", color = "navy") +
  labs(
    title = "Relationship between β and Vd",
    subtitle = paste("Correlation =", round(cor(data$beta, data$Vd, use = "complete.obs"), 3)),
    x = "β elimination rate (g/kg/h)",
    y = "Vd (L/kg)"
  )

```


#### **Advantages of Current Method**

- Simplicity: Easy to implement and explain in court
- Conservative: Using the 97.5th percentiles provides a "benefit of the doubt" to defendants
- Standardised: Same approach across all cases ensures consistency
- Transparent: Clear, reproducible methodology


#### **Limitations of Current Method**

The current forensic method assumes independence between $\beta$ and $V_d$ when calculating the range for $C_t$. However, a Pearson's product-moment correlation analysis reveals a statistically significant negative correlation between these two parameters (correlation coefficient = -0.4036489, p-value = 3.122e-05 < 0.05). This finding directly contradicts the independence assumption underlying the current approach.

Although the official forensic procedure specifies using the 97.5th percentile for both $\beta$ and $V_d$, this convention is based on policy rather than mathematical reasoning. Forensic laboratories apply the same "upper percentile rule" across all parameters to maintain consistency and to err on the side of caution, as using higher parameter values for $\beta$ and $V_d$ generally produces lower blood alcohol estimates. Mathematically Widmark's equation shows that $C_t$ decreases as $\beta$ and $V_d$ both increase, thus the maximum possible value of $C_t$ would occur for low $\beta$ and low $V_d$ values (their 2.5th percentiles). Regardless of which tail is used, the critical statistical issue with the current method is that it assumes that $\beta$ and $V_d$ are independent, when our analysis shows that $\beta$ and $V_d$ have a significant negative correlation.

Assuming independence allows forensic analysts to combine their most extreme values (e.g. highest $\beta$ with highest $V_d$) even though such an extreme combination almost never occurs in practice. This may produce inaccurate $C_t$ estimates, exaggerating how high a person's blood alcohol concentration might have been at the time of interest or significantly underestimating. In statistical terms, the current approach treats the joint distribution of $(\beta, V_d)$ as the product of their marginal distributions, when in reality the joint distribution should account for their negative dependence structure. 

```{r}

# Visualize the joint distribution

ggplot(data, aes(x = beta, y = Vd)) +
  geom_point(alpha = 0.6, color = "steelblue") +
  geom_density_2d(color = "navy") +
  # Add the marginal 97.5th percentiles
  geom_vline(xintercept = quantile(data$beta, 0.975, na.rm = TRUE), 
             linetype = "dashed", color = "red", linewidth = 1) +
  geom_hline(yintercept = quantile(data$Vd, 0.975, na.rm = TRUE), 
             linetype = "dashed", color = "red", linewidth = 1) +
  labs(
    title = "Joint Distribution of β and Vd",
    subtitle = "Red lines show marginal 97.5th percentiles",
    x = "β (g/kg/h)",
    y = "Vd (L/kg)"
  ) +
  annotate("text", 
           x = quantile(data$beta, 0.975, na.rm = TRUE), 
           y = min(data$Vd, na.rm = TRUE),
           label = "97.5th percentile β", 
           hjust = -0.1, color = "red")


```

The above plot of the joint distribution between $\beta$ and $V_d$ shows that there are no points in the top-right corner where both parameters are at their 97.5th marginal quantile simultaneously. 

#### **Potential Alternative Methods**

1. Use the empirical joint distribution of $(\beta, V_d)$ from the data
2. Model the correlation structure explicitly (e.g. through the use of a linear regression model)
3. Bayesian approach with prior distributions for $(\beta, V_d)$ specified and incorporated in the calculation (use eye-witness testimony as your "data" in order to calculate the posterior distribution)

#### **Alternative 1: Empirical Joint Distribution**


```{r}

# Test person (from task 2)
A <- mean(data$A) # Chose this kinda randomly but made the most sense to me 
weight <- 70
t <- 2

# Calculate Ct using empirical joint distribution
data$Ct_joint <- (A / (weight * data$Vd)) - data$beta * t

# Compute the quantiles of C_t
quantile(data$Ct_joint, probs = c(0.025, 0.5, 0.975), na.rm = TRUE)

# Current (independent) approach
beta_ind <- quantile(data$beta, 0.975, na.rm = TRUE)
Vd_ind   <- quantile(data$Vd, 0.975, na.rm = TRUE)
Ct_independent <- (A / (weight * Vd_ind)) - beta_ind * t

# Table comparison
results_compare <- tibble(
  Method = c("Empirical joint (β,Vd)", "Independent 97.5th percentiles"),
  Lower_2.5 = c(round(quantile(data$Ct_joint, 0.025, na.rm = TRUE), 3), ""),
  Median     = c(round(quantile(data$Ct_joint, 0.5, na.rm = TRUE), 3), ""),
  Upper_97.5 = c(round(quantile(data$Ct_joint, 0.975, na.rm = TRUE), 3), 
                 round(Ct_independent, 3))
)

kable(results_compare, align = "lccc",
      caption = "Comparison of Empirical Joint vs Independent Ct")

```


The empirical joint $C_t$ distribution represents the upper and lower bounds of plausible blood alcohol concentrations for an individual with weight 70kg, who consumed the mean grams of alcohol from the sample and was tested 2 hours later.

As seen from the table above this resulted in a range (0.659, 1.455), compared to $C_t$ when assuming independence of $\beta$ and $V_d$ which gave a value of 0.497 which is outside the range of plausible values computed using the joint distribution. This highlights the idea that the current method may be too conservative, resulting in underestimated values of the actual blood alcohol levels of a person at the time of interest.


#### **Alternative 2: Linear Regression**









